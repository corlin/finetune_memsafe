# 需求文档

## 介绍

修复评估引擎中的批次数据处理问题。当前系统在执行文本生成验证任务时，所有批次都被标记为空数据并跳过，导致评估无法正常进行。该问题表现为"批次数据为空"的警告信息，最终导致"没有有效的预测结果，返回默认指标"。

## 需求

### 需求 1

**用户故事:** 作为机器学习工程师，我希望评估引擎能够正确处理和识别批次数据，以便模型评估能够正常执行。

#### 验收标准

1. WHEN 评估引擎接收到包含有效数据的批次 THEN 系统 SHALL 正确识别并处理批次中的输入数据
2. WHEN 批次数据包含text、input或其他有效字段 THEN 系统 SHALL 能够提取这些字段作为模型输入
3. WHEN 数据字段名称不匹配预期格式 THEN 系统 SHALL 提供灵活的字段映射机制
4. WHEN 批次处理完成 THEN 系统 SHALL 记录处理的有效样本数量而不是跳过所有批次

### 需求 2

**用户故事:** 作为开发者，我希望系统能够提供详细的数据结构诊断信息，以便快速定位数据格式问题。

#### 验收标准

1. WHEN 批次数据无法正确解析 THEN 系统 SHALL 记录详细的数据结构信息，包括可用字段和数据类型
2. WHEN 数据字段为空或无效 THEN 系统 SHALL 提供具体的错误原因和建议的修复方案
3. WHEN 数据格式不符合预期 THEN 系统 SHALL 提供数据格式示例和转换建议
4. WHEN 调试模式启用 THEN 系统 SHALL 输出每个批次的详细处理信息

### 需求 3

**用户故事:** 作为系统管理员，我希望评估引擎具有更强的数据容错能力，能够处理多种数据格式。

#### 验收标准

1. WHEN 遇到不同的数据集格式 THEN 系统 SHALL 自动尝试多种字段名称组合（text, input, prompt, question等）
2. WHEN 某些样本数据缺失 THEN 系统 SHALL 跳过无效样本但继续处理其他有效样本
3. WHEN 批次中混合有效和无效数据 THEN 系统 SHALL 只处理有效部分并记录跳过的样本数
4. WHEN 数据预处理失败 THEN 系统 SHALL 提供降级处理方案，确保评估能够继续进行

### 需求 4

**用户故事:** 作为质量保证工程师，我希望系统能够验证数据完整性并提供数据质量报告。

#### 验收标准

1. WHEN 开始批次处理 THEN 系统 SHALL 验证数据集的基本结构和字段完整性
2. WHEN 发现数据质量问题 THEN 系统 SHALL 生成数据质量报告，包括缺失字段、空值比例等统计信息
3. WHEN 数据预处理完成 THEN 系统 SHALL 报告实际处理的样本数量和跳过的样本数量
4. WHEN 评估结束 THEN 系统 SHALL 在评估报告中包含数据处理统计信息

### 需求 5

**用户故事:** 作为研究人员，我希望系统支持自定义数据字段映射，以适应不同的数据集格式。

#### 验收标准

1. WHEN 配置文件中指定字段映射 THEN 系统 SHALL 使用自定义映射规则处理数据
2. WHEN 任务类型不同 THEN 系统 SHALL 根据任务类型应用相应的数据处理逻辑
3. WHEN 需要数据转换 THEN 系统 SHALL 支持基本的数据格式转换（列表转字符串、字典提取等）
4. WHEN 映射规则无效 THEN 系统 SHALL 回退到默认的字段检测逻辑

### 需求 6

**用户故事:** 作为性能优化专家，我希望批次处理逻辑高效且不影响整体评估性能。

#### 验收标准

1. WHEN 处理大批次数据 THEN 系统 SHALL 保持高效的内存使用和处理速度
2. WHEN 数据验证失败 THEN 系统 SHALL 快速跳过无效数据而不阻塞整个流程
3. WHEN 启用详细日志 THEN 系统 SHALL 确保日志记录不显著影响处理性能
4. WHEN 批次大小较大 THEN 系统 SHALL 支持流式处理避免内存溢出